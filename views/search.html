<% include header.html.ejs %>
    <div id="search-page-wrapper">
      <div id="content">
      <section>
        <div id="sort">
          <ul id="sortItems">
            <li class="sortItem" onclick="loadListByName(null,'asc','',0)">저가우선</li>
            <li class="sortItem" onclick="loadListByName(null,'desc','',0)">고가우선</li>
            <li class="sortItem" onclick="loadListByName(null,'','desc',0)">최신순</li>
            <li class="sortItem" onclick="loadListByName(null,'','asc',0)">오래된순</li>
          </ul>
        </div>
        <div id="filter">
          <ul id="filterItems">
            <li class="filterItem">카테고리 일치</li>
            <li class="filterItem">상품명 일치</li>
          </ul>
        </div>
        <ul id="articleSection">
        </ul>
      </section>
      </div>
    </div>
    <script>
    const itemName = <%- '"'+query.item_name+'"' %>; //query인자 값 받기

    //이름으로 로드하기 네임은 키값 프라이스랑 데이트는 asc와 desc를 지원 page는 페이지네이션
    const loadListByName = (name, price, date, page)=>{
      let keyName;
      if(name == null){
        keyName = itemName;
      }else{
        keyName = name;
      }

      $.get("/item",{
        item_name:keyName,
        item_price:price,
        item_data:date,
        start:page*6,
        count:6
      }).done((data)=>{
        $('#articleSection').empty();
        for(let i= 0;i<data.length;i++){
				  let currentTime = new Date(data[i].item_time); //local시간으로 변환
          let dateDiv = $('<div class="itemDate">'+(data[i].item_state=='D'?"거래중":"판매중")+"&nbsp&nbsp"+currentTime.toString().substring(11,currentTime.toString().length-17)+'</div>');
          let userDiv = $('<div class="itemUser" id="'+data[i].owner_id+'-owner">'+"이름 로드실패"+'</div>');
          $.get("/user/"+data[i].owner_id).done((result)=>{
            let str = result[0].user_id;
            if(str.length>6){
              str = str.substring(0, 6);
              str+="..."
            }
            $("#"+result[0].auth_id+"-owner").html(str);
          });
          let firstDiv = $('<div></div>');
          let priceDiv = $('<div class="itemPrice">'+data[i].item_price+'</div>');
          let nameDiv = $('<div class="itemName">'+data[i].item_name+'</div>');
          firstDiv.append(nameDiv);
          firstDiv.append(priceDiv);
          let secondDiv = $('<div></div>');
          secondDiv.append(userDiv);
          secondDiv.append(dateDiv);
          let itemInfoDiv = $('<div class="itemInfo"></div>');
          itemInfoDiv.append(firstDiv);
          itemInfoDiv.append(secondDiv);
          let articleImgDiv = $('<div class="articleIMG"></div>');
          let img = new Image();
          img.id = "image-"+data[i].item_main_image;
          $.get("/item/"+data[i].item_id+"/image/"+data[i].item_main_image).done((result)=>{
            $('#image-'+result[0].image_id).attr("src",result[0].thumb_url);
          });
          articleImgDiv.append(img);
          let itemArticle = $('<li class="article"></li>');
          itemArticle.append(articleImgDiv);
          itemArticle.append(itemInfoDiv);
          $('#articleSection').append(itemArticle);
        }
      }).fail(()=>{
        alert("상품 리스트 불러오기 실패");
      });
    };
    loadListByName(itemName, 'desc', 'desc', 0);

    //카테고리로 로드.
    const loadListByCategory = (category, price, date, page)=>{
      $.get("/item",{
        item_name:name,
        item_price:price,
        item_data:date,
        start:page*6,
        count:6
      }).done((data)=>{
        $('#articleSection').empty();
        for(let i= 0;i<data.length;i++){
          let currentTime = new Date(data[i].item_time); //local시간으로 변환
          let dateDiv = $('<div class="itemDate">'+(data[i].item_state=='D'?"거래중":"판매중")+"&nbsp&nbsp"+currentTime.toString().substring(11,currentTime.toString().length-17)+'</div>');
          let userDiv = $('<div class="itemUser" id="'+data[i].owner_id+'-owner">'+"이름 로드실패"+'</div>');
          $.get("/user/"+data[i].owner_id).done((result)=>{
            let str = result[0].user_id;
            if(str.length>6){
              str = str.substring(0, 6);
              str+="..."
            }
            $("#"+result[0].auth_id+"-owner").html(str);
          });
          let firstDiv = $('<div></div>');
          let priceDiv = $('<div class="itemPrice">'+data[i].item_price+'</div>');
          let nameDiv = $('<div class="itemName">'+data[i].item_name+'</div>');
          firstDiv.append(nameDiv);
          firstDiv.append(priceDiv);
          let secondDiv = $('<div></div>');
          secondDiv.append(userDiv);
          secondDiv.append(dateDiv);
          let itemInfoDiv = $('<div class="itemInfo"></div>');
          itemInfoDiv.append(firstDiv);
          itemInfoDiv.append(secondDiv);
          let articleImgDiv = $('<div class="articleIMG"></div>');
          let img = new Image();
          img.id = "image-"+data[i].item_main_image;
          $.get("/item/"+data[i].item_id+"/image/"+data[i].item_main_image).done((result)=>{
            $('#image-'+result[0].image_id).attr("src",result[0].thumb_url);
          });
          articleImgDiv.append(img);
          let itemArticle = $('<li class="article"></li>');
          itemArticle.append(articleImgDiv);
          itemArticle.append(itemInfoDiv);
          $('#articleSection').append(itemArticle);
        }
      }).fail(()=>{
        alert("상품 리스트 불러오기 실패");
      });
    }
    </script>
<% include footer.html.ejs %>
